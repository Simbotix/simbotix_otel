# FluentBit Configuration for Frappe Server
# Generated by Ansible
#
# Server: {{ server_name }}
# Hostname: {{ server_hostname }}
# Public IP: {{ server_public_ip }}

[SERVICE]
    Flush        5
    Daemon       Off
    Log_Level    info
    Parsers_File parsers.conf

# ============================================
# BENCH-LEVEL LOGS
# ============================================

[INPUT]
    Name             tail
    Tag              frappe.web
    Path             {{ bench_path }}/logs/web.log
    Path_Key         log_file
    Refresh_Interval 5

[INPUT]
    Name             tail
    Tag              frappe.web.error
    Path             {{ bench_path }}/logs/web.error.log
    Path_Key         log_file
    Refresh_Interval 5

[INPUT]
    Name             tail
    Tag              frappe.worker
    Path             {{ bench_path }}/logs/worker.log
    Path_Key         log_file
    Refresh_Interval 5

[INPUT]
    Name             tail
    Tag              frappe.worker.error
    Path             {{ bench_path }}/logs/worker.error.log
    Path_Key         log_file
    Refresh_Interval 5

[INPUT]
    Name             tail
    Tag              frappe.scheduler
    Path             {{ bench_path }}/logs/schedule.log
    Path_Key         log_file
    Refresh_Interval 10

[INPUT]
    Name             tail
    Tag              frappe.frappe
    Path             {{ bench_path }}/logs/frappe.log
    Path_Key         log_file
    Refresh_Interval 5

[INPUT]
    Name             tail
    Tag              frappe.socketio
    Path             {{ bench_path }}/logs/node-socketio.log
    Path_Key         log_file
    Refresh_Interval 10

[INPUT]
    Name             tail
    Tag              frappe.backup
    Path             {{ bench_path }}/logs/backup.log
    Path_Key         log_file
    Refresh_Interval 60

# ============================================
# PER-SITE LOGS
# ============================================
{% for site in frappe_sites %}

[INPUT]
    Name             tail
    Tag              site.{{ site }}
    Path             {{ bench_path }}/sites/{{ site }}/logs/*.log
    Path_Key         log_file
    Refresh_Interval 5
{% endfor %}

# ============================================
# FILTERS - Add Server Identification
# ============================================

# Global server identification for all logs
[FILTER]
    Name             record_modifier
    Match            *
    Record           server.name {{ server_name }}
    Record           server.hostname {{ server_hostname }}
    Record           server.ip {{ server_public_ip }}
    Record           deployment.environment {{ otel_environment }}
    Record           bench.path {{ bench_path }}

# Bench-level logs metadata
[FILTER]
    Name             record_modifier
    Match            frappe.*
    Record           service.name frappe-bench
    Record           service.type bench

# Per-site metadata
{% for site in frappe_sites %}
[FILTER]
    Name             record_modifier
    Match            site.{{ site }}
    Record           service.name {{ site }}
    Record           frappe.site {{ site }}
    Record           service.type site
{% endfor %}

# ============================================
# OUTPUT - Send to ClickStack via OpenTelemetry
# ============================================

[OUTPUT]
    Name                 opentelemetry
    Match                *
    Host                 {{ otel_endpoint | regex_replace('^https?://', '') }}
    Port                 443
    Tls                  On
    Tls.verify           Off
    Header               Authorization {{ otel_api_key }}
    Logs_uri             /v1/logs
    Logs_body_key        $message
    Log_response_payload True
    Add_label            server.name {{ server_name }}
    Add_label            server.ip {{ server_public_ip }}
